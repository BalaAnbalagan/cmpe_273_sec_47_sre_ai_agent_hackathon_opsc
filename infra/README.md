# Infrastructure Directory
## CMPE273 SRE Hackathon - Team OPSC

This directory contains all infrastructure deployment scripts and configuration for the Azure-based Tier-0 SRE application.

---

## Quick Start

### Deploy Infrastructure

```bash
cd scripts
./deploy-infra.sh
```

### Get Configuration

```bash
./get-config.sh
```

### Delete Everything

```bash
./cleanup.sh
```

---

## Directory Structure

```
infra/
├── scripts/
│   ├── deploy-infra.sh      # Main deployment script
│   ├── get-config.sh         # Retrieve URLs and connection strings
│   └── cleanup.sh            # Delete all resources
│
├── mqtt/
│   └── mosquitto.conf        # MQTT broker configuration
│
├── docs/
│   ├── DEPLOYMENT_GUIDE.md   # Detailed deployment instructions
│   └── ARCHITECTURE.md        # Infrastructure architecture documentation
│
├── docker-compose.yml         # Local development stack
└── README.md                  # This file
```

---

## Scripts

### deploy-infra.sh
Deploys complete Azure infrastructure:
- Resource Group
- Virtual Network with 3 subnets
- App Services (Frontend + 2 Backend instances)
- MQTT and RabbitMQ brokers
- Redis Cache (Premium, zone-redundant)
- Cosmos DB (MongoDB API)
- Storage Account

**Time:** ~20-30 minutes
**Cost:** ~$200/week (Production) or ~$65/week (Development)

### get-config.sh
Retrieves all configuration and generates `.env` file:
- Application URLs
- MQTT/RabbitMQ connection details
- Redis connection string
- Cosmos DB connection string
- Storage account keys

**Output:** Creates `.env` file at project root

### cleanup.sh
Deletes the entire resource group and all resources.

**WARNING:** This is irreversible!

---

## Local Development

Start all services locally without Azure:

```bash
docker-compose up -d
```

Services available:
- **MQTT:** localhost:1883
- **RabbitMQ:** localhost:5672, Management UI: localhost:15672
- **Redis:** localhost:6379
- **MongoDB:** localhost:27017
- **PostgreSQL:** localhost:5432

Stop services:

```bash
docker-compose down
```

---

## Azure Resources Created

### Resource Group
- **Name:** rg-cmpe273-sre-hackathon
- **Location:** West US

### Networking
- **VNet:** vnet-sre (10.0.0.0/16)
- **Subnets:** app-subnet, mq-subnet, data-subnet
- **Public IPs:** pip-mqtt, pip-rabbitmq

### Compute
- **App Service Plan:** asp-sre-ha (P1v2, zone-redundant)
- **Frontend:** sre-frontend (Node.js 18)
- **Backend AZ1:** sre-backend-az1 (Python 3.11)
- **Backend AZ2:** sre-backend-az2 (Python 3.11)

### Messaging
- **MQTT:** mqtt-broker (Container Instance)
- **RabbitMQ:** rabbitmq-broker (Container Instance)

### Data
- **Redis:** redis-sre-ha (Premium P1, 6GB)
- **Cosmos DB:** cosmos-sre-mongo (MongoDB API)
- **Storage:** storsreimages* (ZRS)

---

## Configuration

### Environment Variables

After deployment, run `get-config.sh` to generate `.env` file with:

```bash
# Application URLs
FRONTEND_URL=https://sre-frontend.azurewebsites.net
BACKEND_AZ1_URL=https://sre-backend-az1.azurewebsites.net
BACKEND_AZ2_URL=https://sre-backend-az2.azurewebsites.net

# MQTT
MQTT_HOST=<public-ip>
MQTT_PORT=1883

# RabbitMQ
RABBITMQ_HOST=<public-ip>
RABBITMQ_PORT=5672
RABBITMQ_USERNAME=admin
RABBITMQ_PASSWORD=hackathon2024

# Redis
REDIS_HOST=redis-sre-ha.redis.cache.windows.net
REDIS_PORT=6380
REDIS_PASSWORD=<auto-generated>
REDIS_SSL=true

# Cosmos DB
COSMOS_MONGODB_URI=mongodb://...
COSMOS_DATABASE=sre-database

# Storage
AZURE_STORAGE_ACCOUNT=storsreimages*
AZURE_STORAGE_KEY=<auto-generated>

# Cohere AI (you need to add your key)
COHERE_API_KEY=your-api-key-here
```

---

## Cost Management

### Production Setup (~$200/week)
- App Service Plan: P1v2 (zone-redundant)
- Redis Cache: Premium P1
- Full HA and zone redundancy

### Development Setup (~$65/week)
Edit `deploy-infra.sh`:

```bash
# Change App Service SKU
APP_SERVICE_SKU="B1"

# Change Redis SKU
REDIS_SKU="Standard"
REDIS_FAMILY="C"
REDIS_CAPACITY="2"
```

**Note:** Development setup loses zone redundancy and HA features.

---

## Documentation

- **[DEPLOYMENT_GUIDE.md](docs/DEPLOYMENT_GUIDE.md)** - Complete deployment instructions
- **[ARCHITECTURE.md](docs/ARCHITECTURE.md)** - Infrastructure architecture details

---

## Prerequisites

- Azure CLI (2.0+)
- Azure subscription
- Docker & Docker Compose (for local development)

Install Azure CLI:

```bash
# macOS
brew install azure-cli

# Login
az login
```

---

## Troubleshooting

### Deployment Issues

**Problem:** Resource names already taken
**Solution:** Edit script and add unique suffix to resource names

**Problem:** Redis/Cosmos DB taking too long
**Solution:** These services take 10-20 minutes, be patient

**Problem:** Can't connect to MQTT/RabbitMQ
**Solution:** Check public IP and firewall rules

### Get Help

```bash
# Check resource status
az resource list --resource-group rg-cmpe273-sre-hackathon --output table

# Check container logs
az container logs --resource-group rg-cmpe273-sre-hackathon --name mqtt-broker

# Check App Service logs
az webapp log tail --name sre-backend-az1 --resource-group rg-cmpe273-sre-hackathon
```

---

## Next Steps

1. ✅ Deploy infrastructure (`./deploy-infra.sh`)
2. ✅ Get configuration (`./get-config.sh`)
3. ⬜ Share `.env` with Varad & Samip
4. ⬜ Deploy backend code to App Services
5. ⬜ Deploy frontend code to App Service
6. ⬜ Test all endpoints
7. ⬜ Run hackathon demo!

---

**Team OPSC** | Infrastructure Team | CMPE273 SRE Hackathon | November 2025

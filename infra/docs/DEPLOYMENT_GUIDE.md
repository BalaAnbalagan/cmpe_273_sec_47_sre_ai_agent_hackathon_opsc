# Azure Infrastructure Deployment Guide
## CMPE273 SRE Hackathon - Team OPSC

---

## Table of Contents
1. [Prerequisites](#prerequisites)
2. [Quick Start](#quick-start)
3. [Deployment Steps](#deployment-steps)
4. [Getting Configuration](#getting-configuration)
5. [Local Development](#local-development)
6. [Cleanup](#cleanup)
7. [Troubleshooting](#troubleshooting)
8. [Cost Estimation](#cost-estimation)

---

## Prerequisites

### Required Tools
- **Azure CLI** (version 2.0 or higher)
- **Azure Subscription** (with permissions to create resources)
- **Docker & Docker Compose** (for local development)
- **Git** (to clone the repository)

### Install Azure CLI

**macOS:**
```bash
brew install azure-cli
```

**Linux:**
```bash
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```

**Windows:**
Download from: https://aka.ms/installazurecliwindows

### Verify Installation
```bash
az --version
```

---

## Quick Start

### 1. Login to Azure
```bash
az login
```

This will open a browser window. Sign in with your Azure account.

### 2. Set Your Subscription (if you have multiple)
```bash
# List available subscriptions
az account list --output table

# Set active subscription
az account set --subscription "Your Subscription Name"
```

### 3. Deploy Infrastructure
```bash
cd infra/scripts
chmod +x *.sh
./deploy-infra.sh
```

**Deployment Time:** 20-30 minutes

### 4. Get Configuration
```bash
./get-config.sh
```

This will:
- Display all URLs and connection strings
- Generate a `.env` file at the project root

---

## Deployment Steps (Detailed)

### Step 1: Clone Repository
```bash
git clone <your-repo-url>
cd cmpe_273_sec_47_sre_ai_agent_hackathon_opsc
```

### Step 2: Review Configuration

The deployment script will create:

**Resource Group:**
- `rg-cmpe273-sre-hackathon` (West US)

**Networking:**
- Virtual Network: `vnet-sre` (10.0.0.0/16)
- Subnets:
  - `app-subnet` (10.0.1.0/24)
  - `mq-subnet` (10.0.2.0/24)
  - `data-subnet` (10.0.3.0/24)

**Compute:**
- App Service Plan: `asp-sre-ha` (P1v2, Zone 1+2)
- Backend AZ1: `sre-backend-az1`
- Backend AZ2: `sre-backend-az2`
- Frontend: `sre-frontend`

**Messaging:**
- MQTT Broker (Container Instance)
- RabbitMQ Broker (Container Instance)

**Data:**
- Redis Cache: `redis-sre-ha` (Premium P1, 6GB)
- Cosmos DB: `cosmos-sre-mongo` (MongoDB API)
- Storage Account: `storsreimages*` (ZRS)

### Step 3: Run Deployment

```bash
cd infra/scripts
./deploy-infra.sh
```

**What happens:**
1. Checks prerequisites (Azure CLI, login status)
2. Prompts for confirmation
3. Creates resource group
4. Deploys networking components
5. Creates App Services
6. Deploys MQTT and RabbitMQ containers
7. Creates Redis Cache (takes 15-20 minutes)
8. Creates Cosmos DB (takes 5-10 minutes)
9. Creates Storage Account

**Total Time:** 20-30 minutes

### Step 4: Monitor Deployment

You can monitor in the Azure Portal:
```
https://portal.azure.com
→ Resource Groups
→ rg-cmpe273-sre-hackathon
```

Or use Azure CLI:
```bash
az resource list --resource-group rg-cmpe273-sre-hackathon --output table
```

---

## Getting Configuration

After deployment completes:

```bash
cd infra/scripts
./get-config.sh
```

This script will:
1. Retrieve all public URLs
2. Get connection strings and access keys
3. Generate a `.env` file at the project root
4. Display all configuration in the terminal

### Output Includes:

**Application URLs:**
- Frontend: `https://sre-frontend.azurewebsites.net`
- Backend AZ1: `https://sre-backend-az1.azurewebsites.net`
- Backend AZ2: `https://sre-backend-az2.azurewebsites.net`

**MQTT:**
- Host: `<public-ip>`
- Port: `1883` (MQTT), `8883` (MQTT over SSL)

**RabbitMQ:**
- Host: `<public-ip>`
- AMQP Port: `5672`
- Management UI: `http://<public-ip>:15672`
- Username: `admin`
- Password: `hackathon2024`

**Redis:**
- Host: `redis-sre-ha.redis.cache.windows.net`
- Port: `6380` (SSL required)
- Password: `<auto-generated>`

**Cosmos DB:**
- Connection String: `mongodb://...`
- Database: `sre-database`

**Storage:**
- Account: `storsreimages*`
- Containers: `site-images`, `system-logs`

---

## Local Development

For local development without Azure costs:

### 1. Start Local Infrastructure

```bash
cd infra
docker-compose up -d
```

This starts:
- MQTT (port 1883, 9001)
- RabbitMQ (port 5672, 15672)
- Redis (port 6379)
- MongoDB (port 27017)
- PostgreSQL (port 5432)

### 2. Access Services

**RabbitMQ Management:**
```
http://localhost:15672
Username: admin
Password: hackathon2024
```

**MongoDB:**
```bash
mongosh mongodb://admin:hackathon2024@localhost:27017/sre-database?authSource=admin
```

**Redis:**
```bash
redis-cli -a hackathon2024
```

### 3. Stop Services

```bash
docker-compose down
```

### 4. View Logs

```bash
docker-compose logs -f
```

---

## Cleanup

### Delete All Azure Resources

When you're done with the hackathon:

```bash
cd infra/scripts
./cleanup.sh
```

This will:
1. Prompt for confirmation
2. Delete the entire resource group
3. Remove all resources (takes 5-10 minutes)

**WARNING:** This is irreversible!

### Verify Deletion

```bash
az group show --name rg-cmpe273-sre-hackathon
```

You should see: `ResourceGroupNotFound`

---

## Troubleshooting

### Issue: "az: command not found"
**Solution:** Install Azure CLI (see Prerequisites)

### Issue: "Please run 'az login'"
**Solution:**
```bash
az login
```

### Issue: Deployment fails with "Subscription not found"
**Solution:**
```bash
az account set --subscription "Your Subscription Name"
```

### Issue: Resource names already taken
**Solution:** Edit `deploy-infra.sh` and change resource names (add suffix)

### Issue: Redis/Cosmos DB creation timing out
**Solution:** These services take 10-20 minutes. Wait patiently or check Azure Portal.

### Issue: Container instances fail to start
**Solution:**
```bash
az container logs --resource-group rg-cmpe273-sre-hackathon --name mqtt-broker
az container logs --resource-group rg-cmpe273-sre-hackathon --name rabbitmq-broker
```

### Issue: Can't connect to MQTT/RabbitMQ
**Solution:** Check Network Security Groups allow traffic:
```bash
az network nsg rule list --resource-group rg-cmpe273-sre-hackathon --nsg-name <nsg-name> --output table
```

---

## Cost Estimation

### Weekly Costs (7 days)

**Option 1: Production (P1v2 + Premium Redis)**
| Resource | SKU | Cost/Week |
|----------|-----|-----------|
| App Service Plan P1v2 | Zone-redundant | ~$75 |
| Redis Premium P1 | 6GB, zone-redundant | ~$80 |
| Cosmos DB | Serverless | ~$20 |
| Container Instances (2x) | 1-2 CPU | ~$15 |
| Storage + Networking | Standard | ~$10 |
| **TOTAL** | | **~$200/week** |

**Option 2: Cost-Optimized (B1 + Standard Redis)**
| Resource | SKU | Cost/Week |
|----------|-----|-----------|
| App Service Plan B1 | Basic | ~$13 |
| Redis Standard C2 | 2.5GB | ~$18 |
| Cosmos DB | Serverless | ~$20 |
| Container Instances (2x) | 1 CPU | ~$10 |
| Storage + Networking | Standard | ~$5 |
| **TOTAL** | | **~$65/week** |

### To Use Cost-Optimized Version

Edit `infra/scripts/deploy-infra.sh`:

```bash
# Change this line:
APP_SERVICE_SKU="P1v2"

# To this:
APP_SERVICE_SKU="B1"

# And change Redis SKU from:
REDIS_SKU="Premium"
# To:
REDIS_SKU="Standard"
REDIS_FAMILY="C"
REDIS_CAPACITY="2"
```

**Note:** B1 and Standard Redis do **not** support zone redundancy.

### Cost Monitoring

Set up budget alerts:
```bash
az consumption budget create \
  --resource-group rg-cmpe273-sre-hackathon \
  --budget-name "hackathon-budget" \
  --amount 300 \
  --time-grain Monthly \
  --start-date 2025-11-01 \
  --end-date 2025-12-01
```

---

## Next Steps for Varad & Samip

1. **Get the .env file** from the infrastructure team
2. **Deploy backend code** to App Services:
   ```bash
   cd backend/api
   az webapp up --name sre-backend-az1 --resource-group rg-cmpe273-sre-hackathon
   az webapp up --name sre-backend-az2 --resource-group rg-cmpe273-sre-hackathon
   ```

3. **Deploy frontend code** to App Service:
   ```bash
   cd frontend
   az webapp up --name sre-frontend --resource-group rg-cmpe273-sre-hackathon
   ```

4. **Test connectivity**:
   - MQTT: Use MQTT Explorer or mosquitto_pub/sub
   - RabbitMQ: Access management UI
   - Redis: Use redis-cli or Azure Portal
   - Cosmos DB: Use MongoDB Compass

---

## Support

For issues:
- Check [Troubleshooting](#troubleshooting) section
- Review Azure Portal for resource status
- Check container logs: `az container logs`
- Contact infrastructure team (Bala)

---

**Team OPSC** | CMPE273 SRE Hackathon | November 2025
